# Asterisk ARI Outbound Dialer

Приложение на Node.js, которое подключается к ARI интерфейсу Asterisk и инициирует исходящий звонок через указанный транк. После ответа абонента вызов соединяется с внутренним номером 777 (или другим, указанным в переменных окружения).

## Установка

1. Скачайте проект из репозитория и перейдите в его каталог:
   ```bash
   git clone <repo-url>
   cd ari_cc_calls
   ```
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Скопируйте файл `.env.example` в `.env` и заполните значения. Для настроек Asterisk можно ориентироваться на пример файлов из каталога `asterisk_conf` (например, `ari.conf`, `http.conf`, `extensions.conf`).

## Конфигурация окружения

| Переменная | Описание |
| ---------- | -------- |
| `ARI_URL` | URL подключения к ARI (например, `http://asterisk:8088`). |
| `ARI_USERNAME` | Логин ARI пользователя. |
| `ARI_PASSWORD` | Пароль ARI пользователя. |
| `ARI_TRUNK` | Имя транка, заданного в PJSIP (например, `mytrunk`). |
| `OUTBOUND_NUMBER` | Номер, на который выполняется исходящий вызов через транк. Используйте, если нужно позвонить только по одному номеру. |
| `OUTBOUND_NUMBER_FILE` | (Необязательно) Путь к файлу со списком номеров (по одному на строку). Используйте вместо `OUTBOUND_NUMBER` для массовых обзвонов. |
| `TARGET_ENDPOINT` | (Необязательно) Полный endpoint, на который будет соединён звонок после ответа. Если не указано, используется `Local/777@default`. |
| `TARGET_EXTENSION` | (Необязательно) Номер внутреннего абонента для соединения (по умолчанию `777`). Используется только если не задан `TARGET_ENDPOINT`. |
| `TARGET_CONTEXT` | (Необязательно) Контекст диалплана для `Local` вызова (по умолчанию `default`). |
| `STASIS_APP` | (Необязательно) Имя Stasis-приложения (по умолчанию `outbound_dialer`). |
| `CALL_TIMEOUT` | (Необязательно) Таймаут дозвона в секундах (по умолчанию `30`). |
| `CALLER_ID` | (Необязательно) Отображаемый номер при исходящем вызове. |
| `MAX_CC` | (Необязательно) Максимальное число одновременных исходящих звонков. По умолчанию — `1`. |
| `RECORDINGS_DIR` | (Необязательно) Абсолютный или относительный путь, куда будут сохраняться записи. По умолчанию используется подкаталог `recordings` в директории запуска. |
| `RECORDING_FORMAT` | (Необязательно) Формат файлов записей, передаваемый в ARI. По умолчанию — `wav`. |

## Подготовка данных

- Для пакетного обзвона создайте файл `numbers.txt` (или другой путь, указанный в `OUTBOUND_NUMBER_FILE`) со списком номеров, по одному в строке.
- Если нужен единичный звонок, можно указать `OUTBOUND_NUMBER` без файла.

## Запуск через PM2

1. Установите PM2 глобально, если он ещё не установлен:
   ```bash
   npm install -g pm2
   ```
2. Запустите приложение под управлением PM2:
   ```bash
   pm2 start index.js --name ari-calls
   ```
3. Опционально добавьте автозапуск PM2 при загрузке ОС:
   ```bash
   pm2 startup
   pm2 save
   ```

## Старт обзвона

1. Убедитесь, что подготовлен файл номеров и переменные окружения загружены (PM2 подхватывает `.env`).
2. Отправьте HTTP-запрос на старт контроллера из консоли (по умолчанию он слушает на `http://127.0.0.1:3000/start`):
   ```bash
   curl http://127.0.0.1:3000/start
   ```
   Запрос можно повторять: если процесс уже запущен, сервис вернёт сообщение о запущенном состоянии, а при изменении `.env` настройки перечитываются.

## Логи

- Приложение выводит служебные сообщения в stdout; при запуске через PM2 они сохраняются в файлы `~/.pm2/logs/ari-calls-out.log` и `~/.pm2/logs/ari-calls-error.log` и доступны командой:
  ```bash
  pm2 logs ari-calls
  ```
- При включённом MySQL-конфиге (`MYSQL_*`) дополнительно пишутся события о звонках в указанную таблицу базы данных.

## Как это работает

- Приложение устанавливает соединение с ARI и инициирует исходящие вызовы через заданный транк.
- При входе канала в приложение создаётся мост (bridge), к которому добавляются оба канала.
- Когда первый абонент отвечает, приложение автоматически создаёт второй канал и соединяет его с внутренним номером 777 (или указанным значением).
- Как только исходящий канал (`dialer`) переходит в состояние `Up`, приложение инициирует запись разговора через `channels.record` ARI, сохраняя файлы в указанном каталоге.
- После завершения разговора мост очищается, а ресурсы освобождаются.
- При наличии списка номеров приложение хранит очередь номеров и осуществляет параллельные дозвоны в соответствии с лимитом `MAX_CC`.

## Структура

- `index.js` — основной код приложения.
- `.env.example` — пример файла конфигурации.
- `asterisk_conf` — пример конфигурации Asterisk (ARI, HTTP, extensions и т.д.).
